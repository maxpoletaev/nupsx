<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>nuPSX</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
</head>
<body>

  <div id="setup" class="setup">
    <div class="setup__title">nu<span class="setup__title-accent">PSX</span><span class="setup__title-wasm">.wasm</span></div>
    <div class="setup__desc">PlayStation 1 emulator</div>

    <div class="setup__field">
      <span class="setup__label">BIOS</span>
      <input type="file" id="biosFile" accept=".bin">
    </div>

    <div class="exe-group">
      <span class="exe-group__label">PS-EXE</span>
      <input type="file" id="exeFile" accept=".exe,.ps-exe">

      <span class="exe-group__label">Game BIN</span>
      <input type="file" id="binFile" accept=".bin">

      <span class="exe-group__bracket">select<br>the executable</span>
    </div>

    <div class="setup__actions">
      <div></div>
      <button id="startBtn" class="setup__submit">&#9654; Start</button>
    </div>

    <div class="controls">
      <div class="controls__title">Controls</div>
      <div class="controls__grid">
        <div class="binding"><b class="binding__key">WASD</b>   <span class="binding__action">D-Pad</span></div>
        <div class="binding"><b class="binding__key">Enter</b>  <span class="binding__action">Start</span></div>
        <div class="binding"><b class="binding__key">RShift</b> <span class="binding__action">Select</span></div>
        <div class="binding"><b class="binding__key">K</b>      <span class="binding__action">✕ Cross</span></div>
        <div class="binding"><b class="binding__key">L</b>      <span class="binding__action">○ Circle</span></div>
        <div class="binding"><b class="binding__key">J</b>      <span class="binding__action">□ Square</span></div>
        <div class="binding"><b class="binding__key">I</b>      <span class="binding__action">△ Triangle</span></div>
        <div class="binding"><b class="binding__key">Q / E</b>  <span class="binding__action">L2 / L1</span></div>
        <div class="binding"><b class="binding__key">O / U</b>  <span class="binding__action">R2 / R1</span></div>
      </div>
      <div id="gamepadStatus" class="controls__gamepad"><span style="visibility:hidden">●</span></div>
    </div>

    <footer class="footer">
      <a class="footer__link" href="https://github.com/maxpoletaev/nupsx" target="_blank">github.com/maxpoletaev/nupsx</a>
      <span class="footer__sep">·</span>built with <a class="footer__link" href="https://ziglang.org" target="_blank">Zig</a> and
      <a class="footer__link" href="https://github.com/zig-gamedev/zig-gamedev" target="_blank">zig-gamedev</a>
      <div class="footer__legal">
        nuPSX is a personal project made for fun and learning, based on publicly available hardware documentation.
        BIOS and game files are not provided or distributed, you must supply your own legally obtained copies.
        Please Sony don't sue me.
      </div>
    </footer>
  </div>

  <div id="screen" class="screen">
    <div id="fps" class="screen__fps" style="display: none;">FPS: 0</div>
    <canvas id="display" class="screen__canvas" width="320" height="240"></canvas>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const $screen  = document.getElementById('screen');
      const $display = document.getElementById('display');

      function fitCanvas() {
        const ar = ($display.width || 320) / ($display.height || 240);
        const vw = window.innerWidth, vh = window.innerHeight;
        if (vw / vh >= ar) {
          $display.style.height = vh + 'px';
          $display.style.width  = (vh * ar) + 'px';
        } else {
          $display.style.width  = vw + 'px';
          $display.style.height = (vw / ar) + 'px';
        }
      }

      window.addEventListener('resize', fitCanvas);
      new MutationObserver(fitCanvas).observe($display, {
        attributes: true, attributeFilter: ['width', 'height']
      });
      new MutationObserver(() => {
        if (document.getElementById('setup').style.display === 'none') {
          $screen.style.display = 'flex';
          fitCanvas();
        }
      }).observe(document.getElementById('setup'), {
        attributes: true, attributeFilter: ['style']
      });

      const $gamepadStatus = document.getElementById('gamepadStatus');

      function setGamepadConnected(gp) {
        $gamepadStatus.innerHTML = gp
          ? `<span>●</span> Gamepad connected - ${gp.id}`
          : '<span style="visibility:hidden">●</span> Or connect an external gamepad and press any button';
        $gamepadStatus.classList.toggle('controls__gamepad--on', !!gp);
      }

      window.addEventListener('gamepadconnected',    e => setGamepadConnected(e.gamepad));
      window.addEventListener('gamepaddisconnected', () => setGamepadConnected(null));
      setGamepadConnected((navigator.getGamepads() || []).find(gp => gp) || null);
    });
  </script>
  <script src="nupsx.js" defer></script>
</body>
</html>
